# Система администрирования весов CAS LP 1.6

Клиент-серверная система для управления весами CAS LP 1.6 через веб-интерфейс.

## Архитектура

- **Сервер** - Flask веб-приложение с REST API для управления клиентами и данными
- **Клиент** - Python скрипт, работающий на компьютере рядом с весами, обменивается данными с сервером

## Возможности

### Управление товарами (PLU)
- Добавление, редактирование, удаление товаров
- Загрузка товаров в весы
- Загрузка товаров из весов
- Поддержка всех полей протокола весов (названия, цены, сроки годности, логотипы)

### Управление сообщениями
- Создание и редактирование сообщений для печати на этикетках
- Загрузка сообщений в весы

### Мониторинг весов
- Отображение текущего статуса весов (вес, цена, сумма)
- Индикаторы состояния (перегрузка, режим тары, стабильность веса)
- История статусов

### Аналитика продаж
- Общие итоги продаж
- Количество этикеток
- Статистика по PLU
- Сброс данных продаж

### Настройки весов
- Пользовательские настройки (формат этикеток, штрих-коды)
- Заводские настройки (максимальный вес, точность, лимиты)

### Управление клиентами
- Мониторинг подключения клиентов к весам
- Отправка команд клиентам
- Просмотр данных от клиентов

## Установка

### Требования

```bash
pip install flask flask-sqlalchemy requests pyserial
```

### Настройка сервера

1. Скопируйте файлы сервера на компьютер с публичным IP
2. Отредактируйте `server.py`:
   ```python
   app.secret_key = 'your-secret-key-here'  # Измените на свой секретный ключ
   ```
3. Запустите сервер:
   ```bash
   python server.py
   ```

### Настройка клиента

1. Скопируйте `client.py` на компьютер рядом с весами
2. Отредактируйте настройки в `client.py`:
   ```python
   SERVER_URL = 'http://your-server-ip:5000'  # Адрес вашего сервера
   CLIENT_ID = 'scale001'  # Уникальный ID клиента
   SERIAL_PORT = 'COM3'  # Порт весов (измените на нужный)
   ```
3. Запустите клиент:
   ```bash
   python client.py
   ```

## Использование

### Веб-интерфейс

Откройте браузер и перейдите по адресу сервера. Доступные разделы:

- **Клиенты** - список подключенных клиентов и их статус
- **Товары (PLU)** - управление товарами
- **Сообщения** - управление сообщениями для печати
- **Команды весам** - отправка команд весам

### Управление товарами

1. Перейдите в раздел "Товары (PLU)"
2. Добавьте товары через форму
3. Для загрузки в весы:
   - Выберите клиента
   - Нажмите "Отправить в весы"
4. Для загрузки из весов:
   - Выберите клиента
   - Укажите номера товаров через запятую
   - Нажмите "Загрузить из весов"

### Мониторинг весов

1. В списке клиентов нажмите на иконку "Статус весов"
2. Просматривайте текущее состояние и историю
3. Используйте "Команды весам" для получения актуальных данных

### Настройки

1. В списке клиентов нажмите на иконку "Настройки"
2. Просматривайте и редактируйте настройки пользователя и заводские настройки
3. Используйте команды для загрузки настроек с весов

## Протокол связи с весами

Система поддерживает полный протокол CAS LP 1.6:

### Команды PLU
- `0x81` - Получить PLU по номеру
- `0x82` - Создать PLU
- `0x8D` - Удалить PLU
- `0x92` - Сбросить итоги PLU

### Команды статуса
- `0x89` - Получить текущий статус
- `0x85` - Получить общие продажи
- `0x86` - Сбросить общие продажи

### Команды настроек
- `0x95` - Чтение настроек пользователя
- `0x8A` - Запись настроек пользователя
- `0x9B` - Чтение заводских настроек

### Команды сообщений
- `0x83` - Получить сообщение
- `0x84` - Создать сообщение
- `0x8E` - Удалить сообщение

## Структура данных

### PLU (товар)
```python
{
    'number': 1,              # Номер товара
    'name1': 'Название',      # Название строка 1
    'name2': '',              # Название строка 2
    'price': 100.50,          # Цена в рублях
    'code': '000001',         # Код товара
    'group_code': '000000',   # Групповой код
    'tare': 0,                # Тара в граммах
    'message_number': 0,      # Номер сообщения
    'expiry_type': 0,         # Тип срока годности (0-дата, 1-дни)
    'expiry_value': '01.01.25', # Срок годности
    'logo_type': 0,           # Тип логотипа
    'cert_code': ''           # Сертификационный код
}
```

### Статус весов
```python
{
    'weight': 1250,           # Вес в граммах
    'price': 10050,           # Цена в копейках
    'sum': 125625,            # Сумма в копейках
    'plu_number': 1,          # Номер PLU
    'bits': {
        'overload': False,    # Перегрузка
        'tare_mode': False,   # Режим тары
        'zero_weight': True,  # Нулевой вес
        'dual_range': False,  # Двойной диапазон
        'stable_weight': True, # Стабильный вес
        'minus_sign': False   # Минусовый знак
    }
}
```

## Безопасность

- Измените секретный ключ сервера
- Настройте файрвол для ограничения доступа к серверу
- Используйте HTTPS в продакшене
- Регулярно обновляйте пароли

## Логирование

Система ведет подробные логи:
- Клиент: `client.py` выводит логи в консоль
- Сервер: Flask логи доступны в консоли

## Устранение неполадок

### Клиент не подключается к весам
1. Проверьте правильность порта в настройках
2. Убедитесь, что весы включены и готовы к работе
3. Проверьте права доступа к COM-порту

### Клиент не подключается к серверу
1. Проверьте правильность URL сервера
2. Убедитесь, что сервер запущен и доступен
3. Проверьте сетевое подключение

### Данные не загружаются в весы
1. Проверьте статус подключения к весам
2. Убедитесь, что весы не перегружены
3. Проверьте формат данных в логах

## Поддержка

При возникновении проблем:
1. Проверьте логи клиента и сервера
2. Убедитесь в правильности настроек
3. Проверьте подключение к сети и весам 